---
import Layout from "./Layout.astro";
import TableOfContents from "../components/TableOfContents.astro";
import ProgressBar from "../components/ProgressBar.astro"; // <--- NOUVEAU
import { Image } from "astro:assets";
import type { BlogPosting, WithContext } from "schema-dts";

const {
    title,
    description,
    pubDate,
    updatedDate,
    heroImage,
    image,
    imageAlt,
    imageCaption,
    tags,
    aiDisclaimer,
    minutesRead,
    headings,
} = Astro.props;

// Fallback pour l'image
const finalImage = heroImage || image;

const imageURL = finalImage
    ? new URL(finalImage, Astro.site).href
    : new URL("/og-default.png", Astro.site).href; // Une image par défaut c'est mieux

const articleSchema: WithContext<BlogPosting> = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    headline: title,
    description: description,
    image: imageURL,
    datePublished: new Date(pubDate).toISOString(),
    dateModified: updatedDate
        ? new Date(updatedDate).toISOString()
        : new Date(pubDate).toISOString(),
    author: {
        "@type": "Person",
        name: "Valentin Besse", // Mets ton nom ici
        url: Astro.site?.href, // Lien vers ta home ou ta page About
    },
    mainEntityOfPage: {
        "@type": "WebPage",
        "@id": Astro.url.href,
    },
};
---

<Layout title={title} description={description} image={finalImage} schema={articleSchema}>
    <ProgressBar />

    <article class="blog-post-container" data-pagefind-body>
        {
            finalImage && (
                <figure class="hero-figure">
                    <Image
                        src={finalImage}
                        alt={imageAlt || title}
                        class="hero-image"
                        format="webp"
                    />
                    {imageCaption && (
                        <figcaption class="hero-caption">
                            {imageCaption}
                        </figcaption>
                    )}
                </figure>
            )
        }

        <header class="post-header">
            <h1 class="post-title">{title}</h1>
            <div class="metadata">
                <p>Publié le {pubDate}</p>
                {
                    minutesRead && (
                        <>
                            <span class="separator">•</span>
                            <p class="reading-time">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    width="16"
                                    height="16"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                >
                                    <>
                                        <circle cx="12" cy="12" r="10" />
                                        <polyline points="12 6 12 12 16 14" />
                                    </>
                                </svg>
                                {minutesRead} min de lecture
                            </p>
                        </>
                    )
                }
            </div>
        </header>

        <div class="content-wrapper">
            <div class="post-content prose">
                <slot />
            </div>

            {
                headings && headings.length > 0 && (
                    <aside class="sidebar">
                        <TableOfContents headings={headings} />
                    </aside>
                )
            }
        </div>

        {
            (aiDisclaimer || tags) && (
                <footer class="post-footer">
                    {tags && (
                        <div class="post-tags">
                            {tags.map((tag) => (
                                <a href={`/tags/${tag}`} class="tag-link">
                                    #{tag}
                                </a>
                            ))}
                        </div>
                    )}
                    {aiDisclaimer && <p class="ai-note">✨ {aiDisclaimer}</p>}
                </footer>
            )
        }
    </article>
</Layout>

<style>
    /* MISE EN PAGE PRINCIPALE (GRID) */
    .blog-post-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Wrapper pour le contenu et la sidebar */
    .content-wrapper {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        position: relative;
    }

    @media (min-width: 1024px) {
        .content-wrapper {
            grid-template-columns: 1fr 300px;
            gap: 4rem;
        }
        .sidebar {
            display: block;
        }
    }

    @media (max-width: 1023px) {
        .sidebar {
            display: none;
        }
    }

    /* STYLES SPÉCIFIQUES */
    .hero-figure {
        margin: 0 0 2rem 0;
    }
    .hero-image {
        width: 100%;
        height: auto;
        aspect-ratio: 16/9;
        object-fit: cover;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }
    .hero-caption {
        font-size: 0.85rem;
        color: var(--text-muted);
        text-align: center;
        margin-top: 0.5rem;
        font-style: italic;
    }

    .post-header {
        background-color: var(--secondary-bg);
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
    }
    .post-title {
        font-size: 2.5rem;
        line-height: 1.1;
        margin-bottom: 1rem;
        color: var(--text-color);
    }
    .metadata {
        display: flex;
        gap: 0.8rem;
        color: var(--text-muted);
        font-size: 0.9rem;
        align-items: center;
    }
    .reading-time {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        margin: 0;
    }

    /* Contenu Prose (Typographie) */
    .post-content {
        font-size: 1.1rem;
        line-height: 1.8;
        color: var(--text-color);
        overflow-x: hidden;
        max-width: 80ch;
    }

    /* On cible les éléments globaux du markdown ici */
    .post-content :global(img) {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 2rem auto;
    }
    .post-content :global(h2),
    .post-content :global(h3) {
        margin-top: 2rem;
        color: var(--text-color);
    }
    .post-content :global(a) {
        color: var(--accent-color);
        text-decoration: none;
    }
    .post-content :global(a:hover) {
        text-decoration: underline;
    }
    .post-content :global(blockquote) {
        border-left: 4px solid var(--accent-color);
        background: var(--secondary-bg);
        padding: 1rem;
        margin: 1.5rem 0;
        font-style: italic;
    }

    /* Espace pour le bouton copier */
    .post-content :global(pre) {
        position: relative;
        padding-top: 2.5rem;
    }

    /* Footer */
    .post-footer {
        border-top: 1px solid var(--border-color);
        padding-top: 2rem;
        margin-top: 3rem;
    }
    .post-tags {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }
    .tag-link {
        color: var(--accent-color);
        background: rgba(0, 112, 243, 0.1);
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.9rem;
    }
    .ai-note {
        font-size: 0.85rem;
        color: var(--text-muted);
        font-style: italic;
    }

    /* Styles pour le bouton Copy (Injecté par JS) */
    :global(.copy-code) {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        cursor: pointer;
        color: var(--text-muted);
        transition: all 0.2s;
    }
    :global(.copy-code:hover) {
        background-color: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }
    :global(.copy-code.copied) {
        border-color: #10b981;
        color: #10b981;
    }
</style>

<script>
    // LOGIQUE "COPY CODE" OPTIMISÉE POUR CLIENT ROUTER
    const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
    const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;

    function addCopyButtons() {
        const codeBlocks = document.querySelectorAll("pre");

        codeBlocks.forEach((codeBlock) => {
            // Évite de rajouter le bouton si on l'a déjà mis (cas de navigation rapide)
            if (codeBlock.querySelector(".copy-code")) return;

            const wrapper = document.createElement("div");
            wrapper.style.position = "relative";

            const button = document.createElement("button");
            button.className = "copy-code";
            button.innerHTML = copyIcon;
            button.ariaLabel = "Copier le code";

            codeBlock.appendChild(button);

            button.addEventListener("click", async () => {
                const code = codeBlock.querySelector("code")?.innerText;
                if (!code) return;

                await navigator.clipboard.writeText(code);

                button.innerHTML = checkIcon;
                button.classList.add("copied");

                setTimeout(() => {
                    button.innerHTML = copyIcon;
                    button.classList.remove("copied");
                }, 2000);
            });
        });
    }

    // Exécution à chaque chargement de page (navigation initiale + SPA)
    document.addEventListener("astro:page-load", addCopyButtons);
</script>
